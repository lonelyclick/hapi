export type PermissionMode = 'default' | 'acceptEdits' | 'bypassPermissions' | 'plan' | 'read-only' | 'safe-yolo' | 'yolo'
export type CodexModelMode = 'gpt-5.2-codex' | 'gpt-5.1-codex-max' | 'gpt-5.1-codex-mini' | 'gpt-5.2'
export type GrokModelMode = 'grok-4-1-fast-reasoning' | 'grok-4-1-fast-non-reasoning' | 'grok-code-fast-1' | 'grok-4-fast-reasoning' | 'grok-4-fast-non-reasoning' | 'grok-4-0709' | 'grok-3-mini' | 'grok-3'
export type ModelMode = 'default' | 'sonnet' | 'opus' | CodexModelMode | GrokModelMode
export type ModelReasoningEffort = 'low' | 'medium' | 'high' | 'xhigh'

export type WorktreeMetadata = {
    basePath: string
    branch: string
    name: string
    worktreePath?: string
    createdAt?: number
}

export type SessionMetadataSummary = {
    path: string
    host: string
    version?: string
    name?: string
    os?: string
    summary?: { text: string; updatedAt: number }
    machineId?: string
    tools?: string[]
    flavor?: string | null
    runtimeAgent?: string
    runtimeModel?: string
    runtimeModelReasoningEffort?: ModelReasoningEffort
    worktree?: WorktreeMetadata
}

export type AgentStateRequest = {
    tool: string
    arguments: unknown
    createdAt?: number | null
}

export type AgentStateCompletedRequest = {
    tool: string
    arguments: unknown
    createdAt?: number | null
    completedAt?: number | null
    status: 'canceled' | 'denied' | 'approved'
    reason?: string
    mode?: string
    decision?: 'approved' | 'approved_for_session' | 'denied' | 'abort'
    allowTools?: string[]
    answers?: Record<string, string[]>
}

export type AgentState = {
    controlledByUser?: boolean | null
    requests?: Record<string, AgentStateRequest> | null
    completedRequests?: Record<string, AgentStateCompletedRequest> | null
}

export type TodoItem = {
    content: string
    status: 'pending' | 'in_progress' | 'completed'
    priority: 'high' | 'medium' | 'low'
    id: string
}

export type Session = {
    id: string
    createdAt: number
    updatedAt: number
    active: boolean
    thinking: boolean
    metadata: SessionMetadataSummary | null
    agentState: AgentState | null
    todos?: TodoItem[]
    permissionMode?: PermissionMode
    modelMode?: ModelMode
    modelReasoningEffort?: ModelReasoningEffort
}

export type ResumeSessionResponse = {
    type: 'already-active' | 'resumed' | 'created'
    sessionId: string
    resumedFrom?: string
    usedResume?: boolean
}

export type SessionSummaryMetadata = {
    name?: string
    path: string
    machineId?: string
    summary?: { text: string }
    flavor?: string | null
    runtimeAgent?: string
    runtimeModel?: string
    runtimeModelReasoningEffort?: ModelReasoningEffort
    worktree?: WorktreeMetadata
}

export type SessionViewer = {
    email: string
    clientId: string
    deviceType?: string
}

export type OnlineUser = {
    email: string
    clientId: string
    deviceType?: string
    sessionId: string | null
}

export type UserRole = 'developer' | 'operator'

export type User = {
    email: string
    role: UserRole
    createdAt: number
}

export type UsersResponse = { users: User[] }
export type AddUserResponse = { ok: true; users: User[] }
export type UpdateUserRoleResponse = { ok: true; users: User[] }
export type RemoveUserResponse = { ok: true; users: User[] }

export type Project = {
    id: string
    name: string
    path: string
    description: string | null
    createdAt: number
    updatedAt: number
}

export type ProjectsResponse = { projects: Project[] }
export type AddProjectResponse = { ok: true; project: Project; projects: Project[] }
export type UpdateProjectResponse = { ok: true; project: Project; projects: Project[] }
export type RemoveProjectResponse = { ok: true; projects: Project[] }

export type RolePrompt = {
    role: UserRole
    prompt: string
    updatedAt: number
}

export type RolePromptsResponse = { prompts: RolePrompt[] }
export type SetRolePromptResponse = { ok: true; prompts: RolePrompt[] }

export type InputPreset = {
    id: string
    trigger: string
    title: string
    prompt: string
    createdAt: number
    updatedAt: number
}

export type InputPresetsResponse = { presets: InputPreset[] }
export type AddInputPresetResponse = { ok: true; preset: InputPreset; presets: InputPreset[] }
export type UpdateInputPresetResponse = { ok: true; preset: InputPreset; presets: InputPreset[] }
export type RemoveInputPresetResponse = { ok: true; presets: InputPreset[] }

export type SessionSummary = {
    id: string
    active: boolean
    activeAt: number
    updatedAt: number
    metadata: SessionSummaryMetadata | null
    todoProgress: { completed: number; total: number } | null
    pendingRequestsCount: number
    modelMode?: ModelMode
    modelReasoningEffort?: ModelReasoningEffort
    viewers?: SessionViewer[]
}

export type MessageStatus = 'sending' | 'sent' | 'failed'

export type DecryptedMessage = {
    id: string
    seq: number | null
    localId: string | null
    content: unknown
    createdAt: number
    status?: MessageStatus
    originalText?: string
}

export type Machine = {
    id: string
    active: boolean
    metadata: {
        host: string
        platform: string
        happyCliVersion: string
        displayName?: string
    } | null
}

export type AuthResponse = {
    token: string
    user: {
        id: number
        username?: string
        firstName?: string
        lastName?: string
    }
}

export type SessionsResponse = { sessions: SessionSummary[] }
export type SessionResponse = { session: Session }
export type DeleteSessionResponse = { ok: true }
export type MessagesResponse = {
    messages: DecryptedMessage[]
    page: {
        limit: number
        beforeSeq: number | null
        nextBeforeSeq: number | null
        hasMore: boolean
    }
}

export type MachinesResponse = { machines: Machine[] }
export type MachinePathsExistsResponse = { exists: Record<string, boolean> }

export type SpawnLogEntry = {
    timestamp: number
    step: string
    message: string
    status: 'pending' | 'running' | 'success' | 'error'
}

export type SpawnResponse =
    | { type: 'success'; sessionId: string; logs?: SpawnLogEntry[] }
    | { type: 'error'; message: string; logs?: SpawnLogEntry[] }

export type GitCommandResponse = {
    success: boolean
    stdout?: string
    stderr?: string
    exitCode?: number
    error?: string
}

export type FileSearchItem = {
    fileName: string
    filePath: string
    fullPath: string
    fileType: 'file' | 'folder'
}

export type FileSearchResponse = {
    success: boolean
    files?: FileSearchItem[]
    error?: string
}

export type FileReadResponse = {
    success: boolean
    content?: string
    error?: string
}

export type ImageUploadResponse = {
    success: boolean
    path?: string
    error?: string
}

export type GitFileStatus = {
    fileName: string
    filePath: string
    fullPath: string
    status: 'modified' | 'added' | 'deleted' | 'renamed' | 'untracked' | 'conflicted'
    isStaged: boolean
    linesAdded: number
    linesRemoved: number
    oldPath?: string
}

export type GitStatusFiles = {
    stagedFiles: GitFileStatus[]
    unstagedFiles: GitFileStatus[]
    branch: string | null
    totalStaged: number
    totalUnstaged: number
}

export type SlashCommand = {
    name: string
    description?: string
    source: 'builtin' | 'user'
}

export type SlashCommandsResponse = {
    success: boolean
    commands?: SlashCommand[]
    error?: string
}

export type SpeechToTextStreamRequest = {
    streamId: string
    sequenceId: number
    action: 'start' | 'continue' | 'stop' | 'cancel'
    speech: string
    format?: string
    engineType?: string
}

export type SpeechToTextStreamResponse = {
    code?: number
    msg?: string
    data?: {
        recognition_text?: string
    }
    error?: string
    retryAfter?: number | null
}

export type TypingUser = {
    email: string
    clientId: string
    text: string
    updatedAt: number
}

export type AdvisorAlertData = {
    suggestionId: string
    title: string
    detail?: string
    category?: string
    severity: 'critical' | 'high'
    sourceSessionId?: string
}

export type SyncEvent =
    | { type: 'session-added'; sessionId: string; data?: unknown; namespace?: string }
    | { type: 'session-updated'; sessionId: string; data?: unknown; namespace?: string }
    | { type: 'session-removed'; sessionId: string; namespace?: string }
    | { type: 'message-received'; sessionId: string; message: DecryptedMessage; namespace?: string }
    | { type: 'machine-updated'; machineId: string; data?: unknown; namespace?: string }
    | { type: 'connection-changed'; data?: { status: string }; namespace?: string }
    | { type: 'online-users-changed'; users: OnlineUser[]; namespace?: string }
    | { type: 'typing-changed'; sessionId: string; typing: TypingUser; namespace?: string }
    | { type: 'advisor-alert'; alert: AdvisorAlertData; namespace?: string }

export type OnlineUsersResponse = { users: OnlineUser[] }
