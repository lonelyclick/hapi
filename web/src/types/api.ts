export type PermissionMode = 'default' | 'acceptEdits' | 'bypassPermissions' | 'plan' | 'read-only' | 'safe-yolo' | 'yolo'
export type SpawnAgentType = 'claude' | 'codex' | 'gemini' | 'glm' | 'minimax' | 'grok' | 'openrouter' | 'aider-cli' | 'opencode'
export type CodexModelMode = 'gpt-5.3-codex' | 'gpt-5.2-codex' | 'gpt-5.1-codex-max' | 'gpt-5.1-codex-mini' | 'gpt-5.2'
export type GrokModelMode = 'grok-4-1-fast-reasoning' | 'grok-4-1-fast-non-reasoning' | 'grok-code-fast-1' | 'grok-4-fast-reasoning' | 'grok-4-fast-non-reasoning' | 'grok-4-0709' | 'grok-3-mini' | 'grok-3'
export type ModelMode = 'default' | 'sonnet' | 'opus' | CodexModelMode | GrokModelMode
export type ModelReasoningEffort = 'low' | 'medium' | 'high' | 'xhigh'

export type WorktreeMetadata = {
    basePath: string
    branch: string
    name: string
    worktreePath?: string
    createdAt?: number
}

export type SessionMetadataSummary = {
    path: string
    host: string
    version?: string
    name?: string
    os?: string
    summary?: { text: string; updatedAt: number }
    machineId?: string
    tools?: string[]
    flavor?: string | null
    runtimeAgent?: string
    runtimeModel?: string
    runtimeModelReasoningEffort?: ModelReasoningEffort
    worktree?: WorktreeMetadata
    source?: string
    // OpenCode 特有字段
    opencodeCapabilities?: {
        fs: boolean
        terminal: boolean
        mcp: boolean
        tools: string[]
    }
    opencodeStatus?: {
        initialized: boolean
        sessionActive: boolean
        lastActivity?: number
        errorCount?: number
    }
}

export type AgentStateRequest = {
    tool: string
    arguments: unknown
    createdAt?: number | null
}

export type AgentStateCompletedRequest = {
    tool: string
    arguments: unknown
    createdAt?: number | null
    completedAt?: number | null
    status: 'canceled' | 'denied' | 'approved'
    reason?: string
    mode?: string
    decision?: 'approved' | 'approved_for_session' | 'denied' | 'abort'
    allowTools?: string[]
    answers?: Record<string, string[]>
}

export type AgentState = {
    controlledByUser?: boolean | null
    requests?: Record<string, AgentStateRequest> | null
    completedRequests?: Record<string, AgentStateCompletedRequest> | null
}

export type TodoItem = {
    content: string
    status: 'pending' | 'in_progress' | 'completed'
    priority: 'high' | 'medium' | 'low'
    id: string
}

export type Session = {
    id: string
    createdAt: number
    updatedAt: number
    active: boolean
    thinking: boolean
    createdBy?: string
    metadata: SessionMetadataSummary | null
    agentState: AgentState | null
    todos?: TodoItem[]
    permissionMode?: PermissionMode
    modelMode?: ModelMode
    modelReasoningEffort?: ModelReasoningEffort
}

export type ResumeSessionResponse = {
    type: 'already-active' | 'resumed' | 'created'
    sessionId: string
    resumedFrom?: string
    usedResume?: boolean
}

export type SessionSummaryMetadata = {
    name?: string
    path: string
    machineId?: string
    summary?: { text: string }
    flavor?: string | null
    runtimeAgent?: string
    runtimeModel?: string
    runtimeModelReasoningEffort?: ModelReasoningEffort
    worktree?: WorktreeMetadata
    source?: string
    privacyMode?: boolean  // true = 私密模式，不分享给其他人
}

export type SessionViewer = {
    email: string
    clientId: string
    deviceType?: string
}

export type OnlineUser = {
    email: string
    clientId: string
    deviceType?: string
    sessionId: string | null
}

export type UserRole = 'developer' | 'operator'

export type Project = {
    id: string
    name: string
    path: string
    description: string | null
    machineId: string | null  // 关联的机器 ID，null 表示通用项目
    createdAt: number
    updatedAt: number
}

export type ProjectsResponse = { projects: Project[] }
export type AddProjectResponse = { ok: true; project: Project; projects: Project[] }
export type UpdateProjectResponse = { ok: true; project: Project; projects: Project[] }
export type RemoveProjectResponse = { ok: true; projects: Project[] }

export type RolePrompt = {
    role: UserRole
    prompt: string
    updatedAt: number
}

export type RolePromptsResponse = { prompts: RolePrompt[] }
export type SetRolePromptResponse = { ok: true; prompts: RolePrompt[] }

export type InputPreset = {
    id: string
    trigger: string
    title: string
    prompt: string
    createdAt: number
    updatedAt: number
}

export type InputPresetsResponse = { presets: InputPreset[] }
export type AddInputPresetResponse = { ok: true; preset: InputPreset; presets: InputPreset[] }
export type UpdateInputPresetResponse = { ok: true; preset: InputPreset; presets: InputPreset[] }
export type RemoveInputPresetResponse = { ok: true; presets: InputPreset[] }

export type SessionSummary = {
    id: string
    active: boolean
    activeAt: number
    updatedAt: number
    createdBy?: string
    ownerEmail?: string  // 当 session 来自其他用户（开启了 shareAllSessions）时显示
    metadata: SessionSummaryMetadata | null
    todoProgress: { completed: number; total: number } | null
    pendingRequestsCount: number
    modelMode?: ModelMode
    modelReasoningEffort?: ModelReasoningEffort
    viewers?: SessionViewer[]
}

export type MessageStatus = 'sending' | 'sent' | 'failed'

export type DecryptedMessage = {
    id: string
    seq: number | null
    localId: string | null
    content: unknown
    createdAt: number
    status?: MessageStatus
    originalText?: string
}

export type Machine = {
    id: string
    active: boolean
    metadata: {
        host: string
        platform: string
        happyCliVersion: string
        displayName?: string
    } | null
}

export type AuthResponse = {
    token: string
    user: {
        id: number
        username?: string
        firstName?: string
        lastName?: string
    }
}

export type SessionsResponse = { sessions: SessionSummary[] }
export type SessionResponse = { session: Session }
export type DeleteSessionResponse = { ok: true }

// 用户设置类型
export type UserPreferences = {
    shareAllSessions: boolean
    viewOthersSessions: boolean
}
export type UserPreferencesResponse = UserPreferences
export type UpdateUserPreferencesResponse = { ok: true; shareAllSessions: boolean; viewOthersSessions: boolean }

// Session Shares 类型
export type SessionShare = {
    sessionId: string
    sharedWithEmail: string
    sharedByEmail: string
    createdAt: number
}

export type SessionSharesResponse = { shares: SessionShare[] }
export type AddSessionShareResponse = { ok: true }
export type RemoveSessionShareResponse = { ok: true }
export type AllowedUsersResponse = { users: { email: string; role: string }[] }

// Session Privacy Mode 类型
export type SessionPrivacyModeResponse = { privacyMode: boolean }
export type UpdateSessionPrivacyModeResponse = { ok: true; privacyMode: boolean }
export type MessageCountResponse = { count: number }
export type MessagesResponse = {
    messages: DecryptedMessage[]
    page: {
        limit: number
        beforeSeq: number | null
        nextBeforeSeq: number | null
        hasMore: boolean
    }
}

export type MachinesResponse = { machines: Machine[] }
export type MachinePathsExistsResponse = { exists: Record<string, boolean> }

export type SpawnLogEntry = {
    timestamp: number
    step: string
    message: string
    status: 'pending' | 'running' | 'success' | 'error'
}

export type SpawnResponse =
    | { type: 'success'; sessionId: string; logs?: SpawnLogEntry[] }
    | { type: 'error'; message: string; logs?: SpawnLogEntry[] }

export type GitCommandResponse = {
    success: boolean
    stdout?: string
    stderr?: string
    exitCode?: number
    error?: string
}

export type FileReadResponse = {
    success: boolean
    content?: string
    error?: string
}

export type ImageUploadResponse = {
    success: boolean
    path?: string
    error?: string
}

export type FileUploadResponse = {
    success: boolean
    path?: string
    error?: string
}

export type GitFileStatus = {
    fileName: string
    filePath: string
    fullPath: string
    status: 'modified' | 'added' | 'deleted' | 'renamed' | 'untracked' | 'conflicted'
    isStaged: boolean
    linesAdded: number
    linesRemoved: number
    oldPath?: string
}

export type GitStatusFiles = {
    stagedFiles: GitFileStatus[]
    unstagedFiles: GitFileStatus[]
    branch: string | null
    totalStaged: number
    totalUnstaged: number
}

export type SlashCommand = {
    name: string
    description?: string
    source: 'builtin' | 'user'
}

export type SlashCommandsResponse = {
    success: boolean
    commands?: SlashCommand[]
    error?: string
}

export type SpeechToTextStreamRequest = {
    streamId: string
    sequenceId: number
    action: 'start' | 'continue' | 'stop' | 'cancel'
    speech: string
    format?: string
    engineType?: string
}

export type SpeechToTextStreamResponse = {
    code?: number
    msg?: string
    data?: {
        recognition_text?: string
    }
    error?: string
    retryAfter?: number | null
}

export type TypingUser = {
    email: string
    clientId: string
    text: string
    updatedAt: number
}

// Brain SDK 进度事件
export type BrainSdkProgressType = 'thinking' | 'tool' | 'done'
export type BrainSdkProgressData =
    | { progressType: 'thinking'; sessionId?: string }
    | { progressType: 'tool'; toolName?: string; input?: unknown }
    | { progressType: 'done' }

export type SyncEvent =
    | { type: 'session-added'; sessionId: string; data?: unknown; namespace?: string }
    | { type: 'session-updated'; sessionId: string; data?: unknown; namespace?: string }
    | { type: 'session-removed'; sessionId: string; namespace?: string }
    | { type: 'message-received'; sessionId: string; message: DecryptedMessage; namespace?: string }
    | { type: 'messages-cleared'; sessionId: string; namespace?: string }
    | { type: 'machine-updated'; machineId: string; data?: unknown; namespace?: string }
    | { type: 'connection-changed'; data?: { status: string }; namespace?: string }
    | { type: 'online-users-changed'; users: OnlineUser[]; namespace?: string }
    | { type: 'typing-changed'; sessionId: string; typing: TypingUser; namespace?: string }
    | { type: 'brain-sdk-progress'; sessionId: string; brainSessionId: string; progressType: BrainSdkProgressType; data: BrainSdkProgressData; namespace?: string }

export type OnlineUsersResponse = { users: OnlineUser[] }

// Agent Group 相关类型
export type AgentGroupType = 'collaboration' | 'debate' | 'review'
export type AgentGroupStatus = 'active' | 'paused' | 'completed'
export type GroupMemberRole = 'owner' | 'moderator' | 'member'
export type GroupSenderType = 'agent' | 'user' | 'system'
export type GroupMessageType = 'chat' | 'task' | 'feedback' | 'decision'

export type AgentGroup = {
    id: string
    namespace: string
    name: string
    description: string | null
    type: AgentGroupType
    createdAt: number
    updatedAt: number
    status: AgentGroupStatus
    memberCount?: number
}

export type AgentGroupMember = {
    groupId: string
    sessionId: string
    role: GroupMemberRole
    agentType: string | null
    joinedAt: number
    sessionName?: string
    sessionActive?: boolean
}

export type AgentGroupMessage = {
    id: string
    groupId: string
    sourceSessionId: string | null
    senderType: GroupSenderType
    content: string
    messageType: GroupMessageType
    createdAt: number
    senderName?: string
}

export type GroupsResponse = { groups: AgentGroup[] }
export type GroupResponse = { group: AgentGroup; members: AgentGroupMember[] }
export type CreateGroupResponse = { ok: true; group: AgentGroup }
export type UpdateGroupResponse = { ok: true; group: AgentGroup }
export type DeleteGroupResponse = { ok: true }
export type AddMemberResponse = { ok: true; members: AgentGroupMember[] }
export type RemoveMemberResponse = { ok: true; members: AgentGroupMember[] }
export type GroupMessagesResponse = { messages: AgentGroupMessage[] }
export type SendGroupMessageResponse = { ok: true; message: AgentGroupMessage }
export type BroadcastResponse = {
    ok: true
    message: AgentGroupMessage
    broadcast: {
        total: number
        sent: number
        failed: number
        results: Array<{ sessionId: string; success: boolean; error?: string }>
    }
}

// Yoho Credentials 相关类型
export type YohoCredentialFile = {
    type: string
    name: string
    fullPath: string
    relativePath: string
    displayName: string
}

export type YohoCredentialsResponse = {
    success: boolean
    files?: YohoCredentialFile[]
    availableTypes?: string[]
    error?: string
}

export type YohoCredentialTypesResponse = {
    success: boolean
    types?: string[]
    rootPath?: string
}
