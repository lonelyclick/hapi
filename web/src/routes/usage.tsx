import { useState } from 'react'
import { useQuery } from '@tanstack/react-query'
import { useAppContext } from '@/lib/app-context'
import { useAppGoBack } from '@/hooks/useAppGoBack'
import { Spinner } from '@/components/Spinner'

function BackIcon(props: { className?: string }) {
    return (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={props.className}
        >
            <polyline points="15 18 9 12 15 6" />
        </svg>
    )
}

function RefreshIcon(props: { className?: string }) {
    return (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={props.className}
        >
            <polyline points="23 4 23 10 17 10" />
            <polyline points="1 20 1 14 7 14" />
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
        </svg>
    )
}

function formatResetTime(isoString: string): string {
    if (!isoString) return 'Unknown'
    try {
        const date = new Date(isoString)
        const now = new Date()
        const diff = date.getTime() - now.getTime()

        if (diff < 0) return 'Just reset'

        const hours = Math.floor(diff / (1000 * 60 * 60))
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))

        if (hours > 0) {
            return `${hours}h ${minutes}m`
        }
        return `${minutes}m`
    } catch {
        return 'Unknown'
    }
}

function UsageBar(props: { utilization: number; label: string; resetsAt: string }) {
    const percentage = Math.min(100, Math.max(0, props.utilization * 100))
    const isHigh = percentage > 80
    const isMedium = percentage > 50 && percentage <= 80

    return (
        <div className="space-y-1">
            <div className="flex items-center justify-between text-xs">
                <span className="text-[var(--app-hint)]">{props.label}</span>
                <span className={`font-mono ${isHigh ? 'text-red-500' : isMedium ? 'text-yellow-500' : 'text-[var(--app-fg)]'}`}>
                    {percentage.toFixed(1)}%
                </span>
            </div>
            <div className="h-2 bg-[var(--app-border)] rounded-full overflow-hidden">
                <div
                    className={`h-full transition-all duration-300 ${isHigh ? 'bg-red-500' : isMedium ? 'bg-yellow-500' : 'bg-emerald-500'}`}
                    style={{ width: `${percentage}%` }}
                />
            </div>
            <div className="text-[10px] text-[var(--app-hint)]">
                Resets in {formatResetTime(props.resetsAt)}
            </div>
        </div>
    )
}

function formatTokens(tokens: number): string {
    if (tokens >= 1_000_000) {
        return `${(tokens / 1_000_000).toFixed(2)}M`
    }
    if (tokens >= 1_000) {
        return `${(tokens / 1_000).toFixed(1)}K`
    }
    return tokens.toLocaleString()
}

function TokenStats(props: {
    label: string
    data: {
        inputTokens: number
        outputTokens: number
        cacheCreationTokens: number
        cacheReadTokens: number
        totalTokens: number
        sessions: number
    }
}) {
    return (
        <div className="space-y-2">
            <div className="flex items-center justify-between text-xs">
                <span className="text-[var(--app-hint)]">{props.label}</span>
                <span className="font-mono text-[var(--app-fg)]">{formatTokens(props.data.totalTokens)} tokens</span>
            </div>
            <div className="grid grid-cols-2 gap-2 text-[10px]">
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Input</span>
                    <span className="font-mono">{formatTokens(props.data.inputTokens)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Output</span>
                    <span className="font-mono">{formatTokens(props.data.outputTokens)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Cache Create</span>
                    <span className="font-mono">{formatTokens(props.data.cacheCreationTokens)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Cache Read</span>
                    <span className="font-mono">{formatTokens(props.data.cacheReadTokens)}</span>
                </div>
            </div>
            <div className="text-[10px] text-[var(--app-hint)]">
                {props.data.sessions} session{props.data.sessions !== 1 ? 's' : ''}
            </div>
        </div>
    )
}

export default function UsagePage() {
    const { api } = useAppContext()
    const goBack = useAppGoBack()

    const { data, isLoading, error, refetch, isFetching } = useQuery({
        queryKey: ['usage'],
        queryFn: async () => {
            if (!api) throw new Error('API unavailable')
            return await api.getUsage()
        },
        enabled: Boolean(api),
        refetchInterval: 5 * 60_000 // 5 分钟自动刷新
    })

    // 多账号 usage 数据
    const { data: accountsUsage, isLoading: accountsLoading } = useQuery({
        queryKey: ['claude-accounts-usage'],
        queryFn: async () => {
            if (!api) throw new Error('API unavailable')
            return await api.getClaudeAccountsUsage()
        },
        enabled: Boolean(api),
        refetchInterval: 5 * 60_000 // 5 分钟自动刷新
    })

    // 24h hourly analysis
    const { data: hourlyData } = useQuery({
        queryKey: ['usage-hourly'],
        queryFn: async () => {
            if (!api) throw new Error('API unavailable')
            return await api.getHourlyUsage()
        },
        enabled: Boolean(api),
        refetchInterval: 5 * 60_000
    })

    const hasMultipleAccounts = (accountsUsage?.accounts?.length ?? 0) > 1

    return (
        <div className="flex h-full flex-col">
            <div className="bg-[var(--app-bg)] border-b border-[var(--app-divider)] pt-[env(safe-area-inset-top)]">
                <div className="mx-auto w-full max-w-content flex items-center gap-2 px-3 py-1.5">
                    <button
                        type="button"
                        onClick={goBack}
                        className="flex h-7 w-7 shrink-0 items-center justify-center rounded-full text-[var(--app-hint)] transition-colors hover:bg-[var(--app-secondary-bg)] hover:text-[var(--app-fg)]"
                    >
                        <BackIcon />
                    </button>
                    <div className="flex-1 font-medium text-sm">Token Usage</div>
                    <button
                        type="button"
                        onClick={() => refetch()}
                        disabled={isFetching}
                        className="flex h-7 w-7 items-center justify-center rounded-full text-[var(--app-hint)] transition-colors hover:bg-[var(--app-secondary-bg)] hover:text-[var(--app-fg)] disabled:opacity-50"
                        title="Refresh"
                    >
                        <RefreshIcon className={isFetching ? 'animate-spin' : ''} />
                    </button>
                </div>
            </div>

            <div className="flex-1 overflow-y-auto pb-[env(safe-area-inset-bottom)]">
                <div className="mx-auto w-full max-w-content p-3 space-y-4">
                    {isLoading ? (
                        <div className="flex justify-center py-8">
                            <Spinner size="md" label="Loading usage data..." />
                        </div>
                    ) : error ? (
                        <div className="text-center py-8 text-red-500 text-sm">
                            {error instanceof Error ? error.message : 'Failed to load usage data'}
                        </div>
                    ) : (
                        <div className="rounded-lg bg-[var(--app-subtle-bg)] overflow-hidden">
                            <div className="divide-y divide-[var(--app-divider)]">
                                {/* Claude Code Usage - 多账号模式 */}
                                {hasMultipleAccounts ? (
                                    <div className="px-3 py-3">
                                        <div className="flex items-center gap-2 mb-3">
                                            <div className="w-6 h-6 rounded bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center">
                                                <span className="text-white text-xs font-bold">C</span>
                                            </div>
                                            <span className="text-sm font-medium">Claude Accounts</span>
                                        </div>

                                        <div className="space-y-4">
                                            {accountsUsage?.accounts.map((account) => (
                                                <div key={account.accountId} className={`p-2 rounded ${account.isActive ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-[var(--app-bg)]'}`}>
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="text-xs font-medium truncate">{account.accountName}</span>
                                                        {account.isActive && (
                                                            <span className="px-1.5 py-0.5 text-[9px] font-medium rounded bg-emerald-500/20 text-emerald-600">Active</span>
                                                        )}
                                                    </div>
                                                    {account.error ? (
                                                        <div className="text-[10px] text-[var(--app-hint)]">{account.error}</div>
                                                    ) : (
                                                        <div className="space-y-2">
                                                            {account.fiveHour && (
                                                                <UsageBar
                                                                    utilization={account.fiveHour.utilization}
                                                                    label="5-Hour"
                                                                    resetsAt={account.fiveHour.resetsAt}
                                                                />
                                                            )}
                                                            {account.sevenDay && (
                                                                <UsageBar
                                                                    utilization={account.sevenDay.utilization}
                                                                    label="7-Day"
                                                                    resetsAt={account.sevenDay.resetsAt}
                                                                />
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    /* 单账号模式 */
                                    <div className="px-3 py-3">
                                        <div className="flex items-center gap-2 mb-3">
                                            <div className="w-6 h-6 rounded bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center">
                                                <span className="text-white text-xs font-bold">C</span>
                                            </div>
                                            <span className="text-sm font-medium">Claude Code</span>
                                        </div>

                                        {data?.claude?.error ? (
                                            <div className="text-xs text-[var(--app-hint)]">
                                                {data.claude.error}
                                            </div>
                                        ) : data?.claude?.fiveHour || data?.claude?.sevenDay ? (
                                            <div className="space-y-3">
                                                {data.claude.fiveHour && (
                                                    <UsageBar
                                                        utilization={data.claude.fiveHour.utilization}
                                                        label="5-Hour Limit"
                                                        resetsAt={data.claude.fiveHour.resetsAt}
                                                    />
                                                )}
                                                {data.claude.sevenDay && (
                                                    <UsageBar
                                                        utilization={data.claude.sevenDay.utilization}
                                                        label="7-Day Limit"
                                                        resetsAt={data.claude.sevenDay.resetsAt}
                                                    />
                                                )}
                                            </div>
                                        ) : (
                                            <div className="text-xs text-[var(--app-hint)]">
                                                No usage data available
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Local Token Statistics */}
                                {data?.local && !data.local.error && (
                                    <div className="px-3 py-3">
                                        <div className="flex items-center gap-2 mb-3">
                                            <div className="w-6 h-6 rounded bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
                                                <span className="text-white text-xs font-bold">#</span>
                                            </div>
                                            <span className="text-sm font-medium">Token Statistics</span>
                                        </div>

                                        <div className="space-y-4">
                                            <TokenStats label="Today" data={data.local.today} />
                                            <div className="border-t border-[var(--app-divider)] pt-3">
                                                <TokenStats label="All Time" data={data.local.total} />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Codex Usage */}
                                <div className="px-3 py-3">
                                    <div className="flex items-center gap-2 mb-3">
                                        <div className="w-6 h-6 rounded bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                                            <span className="text-white text-xs font-bold">X</span>
                                        </div>
                                        <span className="text-sm font-medium">OpenAI Codex</span>
                                    </div>

                                    {data?.codex?.error ? (
                                        <div className="text-xs text-[var(--app-hint)]">
                                            {data.codex.error}
                                        </div>
                                    ) : data?.codex?.fiveHour || data?.codex?.sevenDay ? (
                                        <div className="space-y-3">
                                            {data.codex.fiveHour && (
                                                <UsageBar
                                                    utilization={data.codex.fiveHour.utilization}
                                                    label="5-Hour Limit"
                                                    resetsAt={data.codex.fiveHour.resetsAt}
                                                />
                                            )}
                                            {data.codex.sevenDay && (
                                                <UsageBar
                                                    utilization={data.codex.sevenDay.utilization}
                                                    label="7-Day Limit"
                                                    resetsAt={data.codex.sevenDay.resetsAt}
                                                />
                                            )}
                                            {data.codex.tokenUsage && (
                                                <div className="pt-2 border-t border-[var(--app-divider)] grid grid-cols-2 gap-2 text-[10px]">
                                                    <div className="flex justify-between">
                                                        <span className="text-[var(--app-hint)]">Input</span>
                                                        <span className="font-mono">{formatTokens(data.codex.tokenUsage.inputTokens)}</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-[var(--app-hint)]">Output</span>
                                                        <span className="font-mono">{formatTokens(data.codex.tokenUsage.outputTokens)}</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-[var(--app-hint)]">Cached</span>
                                                        <span className="font-mono">{formatTokens(data.codex.tokenUsage.cachedInputTokens)}</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-[var(--app-hint)]">Reasoning</span>
                                                        <span className="font-mono">{formatTokens(data.codex.tokenUsage.reasoningOutputTokens)}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="text-xs text-[var(--app-hint)]">
                                            No Codex usage data available
                                        </div>
                                    )}
                                </div>
                            </div>

                            {data?.timestamp && (
                                <div className="px-3 py-2 border-t border-[var(--app-divider)] text-[10px] text-[var(--app-hint)]">
                                    Updated: {new Date(data.timestamp).toLocaleTimeString()}
                                </div>
                            )}
                        </div>
                    )}

                    {/* 24h Analysis Panel */}
                    {hourlyData && !hourlyData.error && hourlyData.hourly.length > 0 && (
                        <HourlyAnalysisPanel data={hourlyData} />
                    )}
                </div>
            </div>
        </div>
    )
}

// --- 24h Analysis Components ---

function shortenProject(name: string): string {
    return name
        .replace(/^-home-[^-]+-/, '')
        .replace(/^softwares-/, '')
        .replace(/^happy-/, '')
}

interface HourlyData {
    hourly: Array<{
        hour: string
        cacheRead: number
        cacheCreate: number
        input: number
        output: number
        messages: number
    }>
    projects: Array<{
        project: string
        cacheRead: number
        cacheCreate: number
        input: number
        output: number
        messages: number
        sessions: number
    }>
    sessions: Array<{
        sessionId: string
        project: string
        model: string
        firstSeen: string
        lastSeen: string
        cacheRead: number
        cacheCreate: number
        messages: number
        toolCalls: number
    }>
    timestamp: number
    error?: string
}

function HourlyAnalysisPanel({ data }: { data: HourlyData }) {
    const [selectedHour, setSelectedHour] = useState<string | null>(null)

    const totalCacheRead = data.hourly.reduce((s, h) => s + h.cacheRead, 0)
    const totalCacheCreate = data.hourly.reduce((s, h) => s + h.cacheCreate, 0)
    const totalMessages = data.hourly.reduce((s, h) => s + h.messages, 0)

    return (
        <div className="rounded-lg bg-[var(--app-subtle-bg)] overflow-hidden">
            <div className="divide-y divide-[var(--app-divider)]">
                {/* Header */}
                <div className="px-3 py-3">
                    <div className="flex items-center gap-2 mb-1">
                        <div className="w-6 h-6 rounded bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
                            <span className="text-white text-xs font-bold">24</span>
                        </div>
                        <span className="text-sm font-medium">24h Analysis</span>
                    </div>
                    <div className="flex gap-4 text-[10px] text-[var(--app-hint)]">
                        <span>Cache Read: <span className="font-mono text-[var(--app-fg)]">{formatTokens(totalCacheRead)}</span></span>
                        <span>Cache Create: <span className="font-mono text-[var(--app-fg)]">{formatTokens(totalCacheCreate)}</span></span>
                        <span>{totalMessages} msgs</span>
                    </div>
                </div>

                {/* Hourly Bar Chart */}
                <div className="px-3 py-3">
                    <div className="text-[10px] text-[var(--app-hint)] mb-2">Hourly Cache Read</div>
                    <HourlyBarChart
                        hourly={data.hourly}
                        selectedHour={selectedHour}
                        onSelect={setSelectedHour}
                    />
                    {selectedHour && (
                        <HourDetail hourly={data.hourly} hour={selectedHour} />
                    )}
                </div>

                {/* Project Ranking */}
                {data.projects.length > 0 && (
                    <div className="px-3 py-3">
                        <div className="text-[10px] text-[var(--app-hint)] mb-2">By Project</div>
                        <div className="space-y-1.5">
                            {data.projects.map((p) => (
                                <div key={p.project} className="flex items-center justify-between text-[10px]">
                                    <span className="truncate flex-1 mr-2">{shortenProject(p.project)}</span>
                                    <div className="flex gap-3 shrink-0">
                                        <span className="font-mono text-[var(--app-fg)]">{formatTokens(p.cacheRead)}</span>
                                        <span className="text-[var(--app-hint)] w-14 text-right">{p.sessions}s / {p.messages}m</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* Session Ranking */}
                {data.sessions.length > 0 && (
                    <div className="px-3 py-3">
                        <div className="text-[10px] text-[var(--app-hint)] mb-2">Top Sessions</div>
                        <div className="space-y-2">
                            {data.sessions.map((s, i) => (
                                <div key={`${s.project}/${s.sessionId}`} className="text-[10px]">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-1.5 min-w-0">
                                            <span className="text-[var(--app-hint)] shrink-0">#{i + 1}</span>
                                            <span className="font-mono truncate">{s.sessionId}</span>
                                            <span className="text-[var(--app-hint)] shrink-0">{shortenProject(s.project)}</span>
                                        </div>
                                        <span className="font-mono text-[var(--app-fg)] shrink-0 ml-2">{formatTokens(s.cacheRead)}</span>
                                    </div>
                                    <div className="flex gap-3 text-[var(--app-hint)] ml-5">
                                        <span>{s.model === '<synthetic>' ? 'synthetic' : s.model.replace('claude-', '')}</span>
                                        <span>{s.firstSeen}-{s.lastSeen}</span>
                                        <span>{s.messages}m</span>
                                        <span>{s.toolCalls}t</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        </div>
    )
}

function HourlyBarChart({ hourly, selectedHour, onSelect }: {
    hourly: HourlyData['hourly']
    selectedHour: string | null
    onSelect: (hour: string | null) => void
}) {
    const maxVal = Math.max(...hourly.map(h => h.cacheRead + h.cacheCreate), 1)

    return (
        <div className="flex items-end gap-px" style={{ height: 80 }}>
            {hourly.map((h) => {
                const crHeight = (h.cacheRead / maxVal) * 100
                const ccHeight = (h.cacheCreate / maxVal) * 100
                const isSelected = selectedHour === h.hour
                const hourLabel = h.hour.split(' ')[1]?.replace(':00', '') ?? ''

                return (
                    <div
                        key={h.hour}
                        className="flex-1 flex flex-col justify-end items-center cursor-pointer group"
                        style={{ height: '100%' }}
                        onClick={() => onSelect(isSelected ? null : h.hour)}
                    >
                        <div className="w-full flex flex-col justify-end" style={{ height: '100%' }}>
                            {/* Cache Create (stacked on top) */}
                            {ccHeight > 0 && (
                                <div
                                    className={`w-full rounded-t-[1px] ${isSelected ? 'bg-amber-400' : 'bg-amber-500/60 group-hover:bg-amber-400/80'}`}
                                    style={{ height: `${ccHeight}%`, minHeight: ccHeight > 0 ? 1 : 0 }}
                                />
                            )}
                            {/* Cache Read */}
                            {crHeight > 0 && (
                                <div
                                    className={`w-full ${ccHeight <= 0 ? 'rounded-t-[1px]' : ''} ${isSelected ? 'bg-purple-400' : 'bg-purple-500/60 group-hover:bg-purple-400/80'}`}
                                    style={{ height: `${crHeight}%`, minHeight: crHeight > 0 ? 1 : 0 }}
                                />
                            )}
                        </div>
                        {/* X-axis label: show every other hour */}
                        <div className="text-[8px] text-[var(--app-hint)] mt-0.5 leading-none">
                            {parseInt(hourLabel) % 2 === 0 ? hourLabel : ''}
                        </div>
                    </div>
                )
            })}
        </div>
    )
}

function HourDetail({ hourly, hour }: { hourly: HourlyData['hourly']; hour: string }) {
    const h = hourly.find(x => x.hour === hour)
    if (!h) return null

    return (
        <div className="mt-2 p-2 rounded bg-[var(--app-bg)] text-[10px]">
            <div className="font-medium mb-1">{h.hour}</div>
            <div className="grid grid-cols-2 gap-x-4 gap-y-0.5">
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Cache Read</span>
                    <span className="font-mono">{formatTokens(h.cacheRead)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Cache Create</span>
                    <span className="font-mono">{formatTokens(h.cacheCreate)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Input</span>
                    <span className="font-mono">{formatTokens(h.input)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-[var(--app-hint)]">Output</span>
                    <span className="font-mono">{formatTokens(h.output)}</span>
                </div>
                <div className="flex justify-between col-span-2">
                    <span className="text-[var(--app-hint)]">Messages</span>
                    <span className="font-mono">{h.messages}</span>
                </div>
            </div>
        </div>
    )
}
