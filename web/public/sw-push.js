/**
 * Web Push Event Handlers for Service Worker
 * This file is imported by the main service worker generated by VitePWA
 *
 * iOS Safari 16.4+ PWA Requirements:
 * - Must be installed to home screen (standalone mode)
 * - User must grant notification permission
 * - Service Worker must be active
 */

// Build version for cache busting (injected at build time)
const SW_VERSION = '__SW_BUILD_VERSION__'
console.log('[sw-push] version:', SW_VERSION)

// Handle incoming push notifications
self.addEventListener('push', (event) => {
    console.log('[sw-push] push event received at', new Date().toISOString())

    const showNotification = async () => {
        let data = {
            title: 'Yoho Remote',
            body: 'Task completed',
            icon: '/pwa-192x192.png',
            badge: '/pwa-64x64.png',
            tag: 'default-' + Date.now()
        }

        if (event.data) {
            try {
                const payload = event.data.json()
                console.log('[sw-push] payload:', JSON.stringify(payload))
                data = {
                    title: payload.title || data.title,
                    body: payload.body || data.body,
                    icon: payload.icon || data.icon,
                    badge: payload.badge || data.badge,
                    tag: payload.tag || data.tag,
                    data: payload.data || {}
                }
            } catch (e) {
                console.error('[sw-push] failed to parse payload:', e)
                try {
                    data.body = event.data.text() || data.body
                } catch (e2) {
                    console.error('[sw-push] failed to get text:', e2)
                }
            }
        }

        // iOS Safari requires minimal options
        const options = {
            body: data.body,
            icon: data.icon,
            badge: data.badge,
            tag: data.tag,
            data: data.data,
            // iOS 需要 renotify 为 true 才能显示相同 tag 的通知
            renotify: true
        }

        console.log('[sw-push] showing notification:', data.title, JSON.stringify(options))

        try {
            await self.registration.showNotification(data.title, options)
            console.log('[sw-push] notification shown successfully')
        } catch (err) {
            console.error('[sw-push] showNotification failed:', err)
        }
    }

    event.waitUntil(showNotification())
})

// Handle notification click
self.addEventListener('notificationclick', (event) => {
    console.log('[sw-push] notification clicked:', event.notification.tag, event.action)
    event.notification.close()

    if (event.action === 'dismiss') {
        return
    }

    // Try to open or focus the app
    const urlToOpen = event.notification.data?.url || '/'

    event.waitUntil(
        self.clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
            // Check if there's already a window open
            for (const client of clientList) {
                if (client.url.includes(self.registration.scope)) {
                    // Focus existing window and navigate if needed
                    client.focus()
                    if (urlToOpen && urlToOpen !== '/') {
                        client.navigate(urlToOpen)
                    }
                    return
                }
            }

            // No existing window, open a new one
            const fullUrl = new URL(urlToOpen, self.registration.scope).href
            return self.clients.openWindow(fullUrl)
        })
    )
})

// Handle notification close (for analytics/cleanup if needed)
self.addEventListener('notificationclose', (event) => {
    console.log('[sw-push] notification closed:', event.notification.tag)
})

// Handle push subscription change (important for iOS)
// This fires when the subscription is invalidated
self.addEventListener('pushsubscriptionchange', (event) => {
    console.log('[sw-push] subscription changed, need to resubscribe')
    // The client will need to resubscribe when it next opens
})

console.log('[sw-push] push handlers registered, version:', SW_VERSION)
