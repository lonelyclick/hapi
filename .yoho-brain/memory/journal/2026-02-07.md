# 2026-02-07

## Brain 模块全面排查与修复

- 对 brain 模块进行端到端测试，验证后端 API 数据结构与前端类型定义匹配
- 发现并修复 4 个问题：
  1. **brain-sdk display session 无心跳**：SDK 模式创建的 display session 2 分钟后被判为 inactive 进入 archive。在 `autoBrain.ts` 的 syncRounds 和 triggerSdkReview 中加了 `keepBrainDisplaySessionAlive()` 心跳调用
  2. **Brain 按钮不显示**：`SessionChat.tsx` 没有传 `onOpenBrain` prop 给 `SessionHeader`，导致按钮永远不渲染。加上了 navigate 回调
  3. **brain-sdk session 列表过滤遗漏**：`SessionList.tsx` 的 brain 过滤器只匹配 `source=brain`，不匹配 `source=brain-sdk`。改为同时匹配两种
  4. **mainSessionIdForBrain 逻辑错误**：普通主 session 拿不到正确的 brain 查询 ID。重写了判断逻辑
- 清理了数据库中 3 条孤立的 brain_sessions 记录（主 session 已被删除 + 1 条 sdk-mode 遗留）
- 详细经验记录在 `.yoho-brain/memory/insights/brain-module-debugging.md`

## StatusBar vibing 文字抖动 + thinking 状态卡死修复

- 问题：session 恢复后 StatusBar 显示 "xxxing…" 不停跳动
- 根因分析：
  1. StatusBar 的 `getConnectionStatus` 在 thinking=true 时用 `Math.random()` 选词，而 `useMemo` 依赖 `agentState` 对象引用，每次 SSE 推送都触发重算
  2. session resume 时服务端没有重置 thinking 状态，保留了旧的 thinking=true
  3. CLI 的 `claudeRemoteLauncher.ts` inner finally 没有重置 thinking
- 修复：
  1. `StatusBar.tsx`：新增 `useVibingMessage` hook，用 `setInterval` 每 3 秒切换一次词
  2. `sessions.ts`：resume 预激活时加 `session.thinking = false`
  3. `claudeRemoteLauncher.ts`：inner finally 中加 `session.onThinkingChange(false)`（需要 --daemon 部署生效）
